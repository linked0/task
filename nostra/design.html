<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostra - Design Analysis</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; padding: 20px; background: #f5f5f5; }
        h1, h2, h3 { color: #333; }
        h1 { border-bottom: 2px solid #e74c3c; padding-bottom: 10px; }
        h2 { color: #e74c3c; margin-top: 30px; }
        h3 { color: #2c3e50; }
        .error-box { background: #fce4e4; border-left: 4px solid #e74c3c; padding: 15px; margin: 20px 0; }
        .solution-box { background: #e8f5e9; border-left: 4px solid #4caf50; padding: 15px; margin: 20px 0; }
        .warning-box { background: #fff3e0; border-left: 4px solid #ff9800; padding: 15px; margin: 20px 0; }
        .info-box { background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin: 20px 0; }
        .code-block { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; overflow-x: auto; font-family: 'Fira Code', monospace; font-size: 13px; white-space: pre; }
        .code-block .comment { color: #6a9955; }
        .code-block .keyword { color: #569cd6; }
        .code-block .string { color: #ce9178; }
        .code-block .function { color: #dcdcaa; }
        .file-path { font-family: monospace; background: #e0e0e0; padding: 2px 6px; border-radius: 3px; }
        .inline-code { font-family: monospace; background: #e8e8e8; padding: 2px 6px; border-radius: 3px; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #333; color: white; }
        tr:nth-child(even) { background: #f9f9f9; }
        .flow-diagram { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .step { display: inline-block; background: #3498db; color: white; padding: 8px 16px; border-radius: 20px; margin: 5px; }
        .step-error { background: #e74c3c; }
        .step-success { background: #4caf50; }
        .arrow { display: inline-block; margin: 0 10px; color: #666; }
        .version-compare { display: flex; gap: 20px; }
        .version-compare > div { flex: 1; }
    </style>
</head>
<body>

<h1>Task-1: Claim "Not Resolved" Error Analysis</h1>
<p><strong>Date:</strong> December 12, 2025</p>
<p><strong>Error Message:</strong> <code>Failed to claim: execution reverted: "Not resolved"</code></p>

<h2>1. Error Analysis</h2>

<div class="error-box">
    <h3>Error Origin</h3>
    <p>The error occurs in <span class="file-path">ConditionalTokens.sol:160</span></p>
    <div class="code-block"><span class="keyword">function</span> <span class="function">redeemPositions</span>(...) <span class="keyword">external</span> {
    Condition <span class="keyword">storage</span> condition = conditions[conditionId];
    <span class="keyword">require</span>(condition.isResolved, <span class="string">"Not resolved"</span>);  <span class="comment">// &lt;-- Line 160</span>
    ...
}</div>
    <p>The <code>redeemPositions</code> function checks if the condition has been resolved on-chain before allowing token redemption.</p>
</div>

<h2>2. Root Cause: Uncommitted Code Regression</h2>

<div class="info-box">
    <h3>Key Discovery: Committed Code is Correct</h3>
    <p>The <strong>committed code (HEAD)</strong> uses the correct function <code>adminFinalizeResolution()</code>.</p>
    <p>The <strong>uncommitted changes</strong> introduced a broken function call <code>resolveMarket()</code> which does NOT exist in the contract ABI.</p>
</div>

<h3>Version Comparison</h3>
<table>
    <tr>
        <th>Version</th>
        <th>Function Called</th>
        <th>Status</th>
    </tr>
    <tr style="background: #e8f5e9;">
        <td><strong>Committed (HEAD)</strong></td>
        <td><code>adminFinalizeResolution(questionId, outcomeSlotCount, payouts)</code></td>
        <td style="color: #4caf50; font-weight: bold;">CORRECT</td>
    </tr>
    <tr style="background: #fce4e4;">
        <td><strong>Uncommitted (working)</strong></td>
        <td><code>resolveMarket(questionId, payoutIndex)</code></td>
        <td style="color: #e74c3c; font-weight: bold;">BROKEN</td>
    </tr>
</table>

<h3>Committed Code (Working)</h3>
<div class="code-block"><span class="comment">// Committed version - CORRECT</span>
<span class="keyword">const</span> outcomeSlotCount = mkt.outcomes.length; <span class="comment">// 2 for binary markets</span>
<span class="keyword">const</span> tx = <span class="keyword">await</span> resolutionOracle.<span class="function">adminFinalizeResolution</span>(
    mkt.questionId,
    outcomeSlotCount,
    payouts
);
<span class="keyword">await</span> tx.wait();
txHashes.push(tx.hash);</div>

<h3>Uncommitted Code (Broken)</h3>
<div class="code-block"><span class="comment">// Uncommitted changes - BROKEN (resolveMarket does NOT exist!)</span>
<span class="keyword">try</span> {
    <span class="keyword">const</span> tx = <span class="keyword">await</span> resolutionOracle.<span class="function">resolveMarket</span>(mkt.questionId, payoutIndex);
    <span class="keyword">await</span> tx.wait();
    txHashes.push(tx.hash);
} <span class="keyword">catch</span> (e: any) {
    console.warn(<span class="string">`On-chain resolution failed: ${e.message}`</span>);
    <span class="comment">// Silently continues - DB updated but on-chain NOT resolved!</span>
}</div>

<h2>3. The Problem with Uncommitted Changes</h2>

<div class="error-box">
    <h3>Why the Uncommitted Code Fails</h3>
    <ol>
        <li><code>resolveMarket()</code> does NOT exist in the ResolutionOracle contract ABI</li>
        <li>The call throws an error, caught by try/catch</li>
        <li>Code continues and updates DB to <code>RESOLVED</code></li>
        <li>On-chain <code>condition.isResolved</code> remains <code>false</code></li>
        <li>User tries to claim → <code>redeemPositions()</code> reverts with "Not resolved"</li>
    </ol>
</div>

<h3>Available Functions in ResolutionOracle</h3>
<table>
    <tr>
        <th>Function</th>
        <th>Parameters</th>
        <th>Access</th>
        <th>Description</th>
    </tr>
    <tr>
        <td><code>proposeResolution</code></td>
        <td>questionId, outcomeSlotCount, payouts[]</td>
        <td>onlyResolver</td>
        <td>Proposes resolution, starts dispute period</td>
    </tr>
    <tr>
        <td><code>finalizeResolution</code></td>
        <td>questionId, outcomeSlotCount</td>
        <td>onlyResolver</td>
        <td>Finalizes after dispute period (1 day)</td>
    </tr>
    <tr style="background: #e8f5e9;">
        <td><strong><code>adminFinalizeResolution</code></strong></td>
        <td>questionId, outcomeSlotCount, payouts[]</td>
        <td>onlyOwner</td>
        <td><strong>Immediate resolution - bypasses dispute period (CORRECT FUNCTION)</strong></td>
    </tr>
    <tr style="background: #fce4e4;">
        <td><s><code>resolveMarket</code></s></td>
        <td>-</td>
        <td>-</td>
        <td><strong>DOES NOT EXIST</strong></td>
    </tr>
</table>

<h2>4. Execution Flow Comparison</h2>

<div class="flow-diagram">
    <h3>Uncommitted Code Flow (BROKEN)</h3>
    <span class="step">Admin clicks Resolve</span>
    <span class="arrow">&#8594;</span>
    <span class="step step-error">resolveMarket() throws error</span>
    <span class="arrow">&#8594;</span>
    <span class="step">catch: console.warn()</span>
    <span class="arrow">&#8594;</span>
    <span class="step">DB Updated (RESOLVED)</span>
    <span class="arrow">&#8594;</span>
    <span class="step">User clicks Claim</span>
    <span class="arrow">&#8594;</span>
    <span class="step step-error">redeemPositions() REVERTS</span>
</div>

<div class="flow-diagram">
    <h3>Committed Code Flow (CORRECT)</h3>
    <span class="step">Admin clicks Resolve</span>
    <span class="arrow">&#8594;</span>
    <span class="step step-success">adminFinalizeResolution()</span>
    <span class="arrow">&#8594;</span>
    <span class="step step-success">reportPayouts() called</span>
    <span class="arrow">&#8594;</span>
    <span class="step step-success">condition.isResolved = true</span>
    <span class="arrow">&#8594;</span>
    <span class="step">DB Updated (RESOLVED)</span>
    <span class="arrow">&#8594;</span>
    <span class="step">User clicks Claim</span>
    <span class="arrow">&#8594;</span>
    <span class="step step-success">redeemPositions() SUCCESS</span>
</div>

<h2>5. Solution</h2>

<div class="solution-box">
    <h3>Option 1: Discard Uncommitted Changes (Recommended)</h3>
    <p>If the uncommitted changes to <code>admin.ts</code> are not needed, simply restore the committed version:</p>
    <div class="code-block">git checkout api/src/routes/admin.ts</div>
    <p>This will restore the working <code>adminFinalizeResolution()</code> calls.</p>
</div>

<div class="warning-box">
    <h3>Option 2: Fix the Uncommitted Changes</h3>
    <p>If the uncommitted changes contain other necessary modifications, replace the broken <code>resolveMarket()</code> calls:</p>
    <div class="code-block"><span class="comment">// Replace this (BROKEN):</span>
<span class="keyword">const</span> tx = <span class="keyword">await</span> resolutionOracle.<span class="function">resolveMarket</span>(mkt.questionId, payoutIndex);

<span class="comment">// With this (CORRECT):</span>
<span class="keyword">const</span> outcomeSlotCount = 2;
<span class="keyword">const</span> payouts = payoutIndex === 0 ? [100, 0] : [0, 100];
<span class="keyword">const</span> tx = <span class="keyword">await</span> resolutionOracle.<span class="function">adminFinalizeResolution</span>(
    mkt.questionId,
    outcomeSlotCount,
    payouts
);</div>
</div>

<h2>6. Payout Array Format</h2>

<div class="info-box">
    <h3>Important: Payouts Array</h3>
    <p>The <code>adminFinalizeResolution</code> function requires a payouts array, not just an index:</p>
    <table>
        <tr>
            <th>Winning Outcome</th>
            <th>payoutIndex</th>
            <th>payouts Array</th>
        </tr>
        <tr>
            <td>YES (first outcome)</td>
            <td>0</td>
            <td><code>[100, 0]</code></td>
        </tr>
        <tr>
            <td>NO (second outcome)</td>
            <td>1</td>
            <td><code>[0, 100]</code></td>
        </tr>
    </table>
    <p>The values represent percentage (100 = full payout to that outcome, 0 = no payout).</p>
</div>

<h2>7. Markets Affected</h2>

<div class="warning-box">
    <h3>Markets Resolved with Broken Code</h3>
    <p>Any markets resolved while running the uncommitted code are in an inconsistent state:</p>
    <ul>
        <li><strong>Database:</strong> status = 'RESOLVED'</li>
        <li><strong>On-Chain:</strong> condition.isResolved = false</li>
    </ul>
    <p><strong>To fix these markets:</strong></p>
    <ol>
        <li>Identify all markets with <code>status: 'RESOLVED'</code> in the database</li>
        <li>For each market, call <code>adminFinalizeResolution</code> manually or via a migration script</li>
        <li>Verify on-chain resolution using <code>conditionalTokens.conditions(conditionId).isResolved</code></li>
    </ol>
</div>

<h2>8. Summary</h2>

<table>
    <tr>
        <th>Aspect</th>
        <th>Details</th>
    </tr>
    <tr>
        <td><strong>Root Cause</strong></td>
        <td>Uncommitted changes introduced broken <code>resolveMarket()</code> call</td>
    </tr>
    <tr>
        <td><strong>Committed Code</strong></td>
        <td>Correct - uses <code>adminFinalizeResolution()</code></td>
    </tr>
    <tr>
        <td><strong>Fix</strong></td>
        <td>Discard changes or fix <code>resolveMarket</code> → <code>adminFinalizeResolution</code></td>
    </tr>
    <tr>
        <td><strong>Restart Required</strong></td>
        <td>Yes - API server restart needed after fix</td>
    </tr>
</table>

<h2>9. Git Commands Reference</h2>

<div class="code-block"><span class="comment"># View current changes</span>
git diff api/src/routes/admin.ts

<span class="comment"># Discard uncommitted changes to admin.ts (restore working version)</span>
git checkout api/src/routes/admin.ts

<span class="comment"># Or selectively stage other changes and reset admin.ts</span>
git stash
git checkout api/src/routes/admin.ts
git stash pop</div>

</body>
</html>
