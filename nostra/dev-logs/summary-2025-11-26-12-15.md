# Summary: Claimed History & Test Plan Updates
**Date**: 2025-11-26 12:15
**Author**: Antigravity

## Completed Tasks

### 1. Add "Claimed" Status to History
**Objective**: Show redeemed positions in the user's activity history.

**Changes**:
*   **Database**: Added `Redemption` model to `schema.prisma` to track claim events.
    *   Fields: `userId`, `marketId`, `outcomeId`, `amount`, `payout`, `transactionHash`.
*   **API**:
    *   Updated `api/src/routes/redemption.ts`: Added `POST /confirm` endpoint to record successful redemptions.
    *   Updated `api/src/routes/users.ts`: Modified `GET /:address/history` to fetch `Redemption` records, merge them with `Trade` records, and sort by timestamp.
*   **Frontend**:
    *   Updated `web/src/app/my-positions/page.tsx`: Calls `POST /api/redemption/confirm` after a successful blockchain transaction.
    *   Updated `web/src/components/my-positions/HistoryList.tsx`: Handles `CLAIMED` event type, displaying it with a "Claimed" badge and green styling.

### 2. Limit Order Fixes
**Objective**: Ensure Limit Order inputs are treated as Shares and UI is correct.

**Changes**:
*   **`web/src/hooks/useTrade.ts`**: Modified `placeLimitOrder` to treat `params.amount` as **Shares** for both Buy and Sell sides.
*   **`web/src/app/market/[id]/page.tsx`**:
    *   Updated input label to "Shares" for Limit Orders.
    *   Added `pr-10` to Limit Price input to fix text overlap with `¢` symbol.
    *   Updated Quick Amount buttons to show "+1", "+5", etc. (Shares) instead of "+$1" when in Limit Order mode.
    *   Updated `Header.tsx` to display **Available Balance** (Cash - Locked in Orders) and added a tooltip showing the breakdown.

### 3. Available Balance Implementation
**Objective**: Improve UX by logically locking funds for open orders.

**Changes**:
*   **`api/src/routes/users.ts`**: Updated `GET /portfolio` to calculate `lockedBalance` (sum of open buy orders) and return `cashBalance` as `availableBalance`.
*   **`web/src/components/Header.tsx`**: Added state for `totalBalance` and `lockedBalance` and a tooltip to explain the displayed "Cash" amount.

### 4. UI Improvements
**Objective**: Enhance usability and correctness.

**Changes**:
*   **Test 5 (Sweeping the Orderbook)**: Added a test case to verify multi-level fills for large market orders, ensuring the system correctly handles liquidity consumption across different price points.
*   **Test 6 (Redemption)**: Added a test case to verify the winnings claiming process and fee calculation logic.
*   **Updated Calculations**: Revised expected values in Test 1 based on fee logic (4% of profit).
*   **New Script**: Created `api/scripts/show-trader-balances.ts` (run via `yarn show:balances`) to quickly check mUSDC balances for all traders and the server wallet.
*   **Reset Button**: Added a "Reset" button to the Amount input in `MarketPage.tsx`.
*   **History Display**:
    *   Fixed `HistoryList.tsx` to display "Sold" transactions with a positive (`+`) sign and green color.
    *   Implemented **Trade Grouping**: Trades for the same market and action within a 1-minute window are now aggregated. This handles cases where a single "Market" order executes as multiple blockchain transactions.
*   **My Positions**: Filtered out positions with 0 shares (or < 0.001) to reduce clutter.
*   **Header**: Made the "Cash" balance indicator clickable, linking to the My Positions page.
*   **Price Formatting**: Updated `HistoryList.tsx` to display prices in cents (e.g., "48¢") instead of fractional cents (e.g., "0.48¢").
*   **Blinking Outcome**: Added a pulse animation to the outcome title in the Trade Panel when the selection changes, improving user feedback.

### 6. Investigation of "Missing" Trades
*   **Observation**: User sold ~97 shares but history only shows ~47 shares sold.
*   **Analysis**:
    *   **Grouping Removed**: Based on user feedback ("make a trader confused"), the trade grouping logic was removed. The history now displays each individual trade match separately.
    *   **Incomplete Fill**: The discrepancy (~50 shares unsold) indicates that the **Market Sell stopped early**, likely because it consumed all available Buy orders (Liquidity) in the order book. The remaining shares are still in the user's position.
    *   **Missing History Records**: Some trades executed on-chain (confirmed by balance) but failed to save to DB due to timeouts. Added a **1-second delay** in the `useTrade` loop to prevent server overload and ensure all trades are recorded in future tests.

### 8. UI Refinements
*   **Price Formatting**: Updated history list to show prices as `$0.48` and shares rounded to 2 decimals (e.g. `17.31 shares`).
*   **Blinking Outcome**: Changed the animation to flash the **background of the outcome card** (container) instead of the text, providing a more vivid effect while maintaining the card styling.
*   **Tab Titles**: Removed the count display `(0)` from the **History** tab title in "My Positions" page to avoid confusion, as the history data is fetched independently.

### 9. Test Plan Updates
**Objective**: Clarify off-chain order behavior and update expected results.

**Changes**:
*   **Updated `test/test-plan.md`**:
    *   Calculated exact final balances for Test 1, 2, and 4 based on the new Initial State (100k Server, 1k Traders).
    *   Clarified that off-chain orders don't lock on-chain funds immediately.
    *   **Test 3 (Order Cancellation)**: Verifies funds are locked on order placement and refunded on cancellation.
    *   **Test 4 (Market Sell)**: Verifies selling shares into existing liquidity (hitting the bid) and converting back to USDC.

## Original Request
> **Task-1**:
> ![ ](image-1.png)
> How about add claimed in history?

## Next Steps
1.  **Restart API Server**: Required to apply database schema changes and load new routes.
2.  **Run `npx prisma db push`**: Ensure the database schema is synced (if not already done).
3.  **Verify Feature**:
    *   Claim a winning position.
    *   Check "History" tab for the "Claimed" entry.
4.  **Execute New Tests**: Run Test 3 and Test 4 from the test plan.
