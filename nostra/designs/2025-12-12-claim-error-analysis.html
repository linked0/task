<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Error Analysis - December 12, 2025</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; padding: 20px; background: #f5f5f5; }
        h1, h2, h3 { color: #333; }
        h1 { border-bottom: 2px solid #e74c3c; padding-bottom: 10px; }
        h2 { color: #e74c3c; margin-top: 30px; }
        h3 { color: #2c3e50; }
        .error-box { background: #fce4e4; border-left: 4px solid #e74c3c; padding: 15px; margin: 20px 0; }
        .solution-box { background: #e8f5e9; border-left: 4px solid #4caf50; padding: 15px; margin: 20px 0; }
        .warning-box { background: #fff3e0; border-left: 4px solid #ff9800; padding: 15px; margin: 20px 0; }
        .code-block { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; overflow-x: auto; font-family: 'Fira Code', monospace; font-size: 13px; white-space: pre; }
        .code-block .comment { color: #6a9955; }
        .code-block .keyword { color: #569cd6; }
        .code-block .string { color: #ce9178; }
        .code-block .function { color: #dcdcaa; }
        .file-path { font-family: monospace; background: #e0e0e0; padding: 2px 6px; border-radius: 3px; }
        .inline-code { font-family: monospace; background: #e8e8e8; padding: 2px 6px; border-radius: 3px; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #333; color: white; }
        tr:nth-child(even) { background: #f9f9f9; }
        .flow-diagram { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .step { display: inline-block; background: #3498db; color: white; padding: 8px 16px; border-radius: 20px; margin: 5px; }
        .step-error { background: #e74c3c; }
        .arrow { display: inline-block; margin: 0 10px; color: #666; }
    </style>
</head>
<body>

<h1>Claim "Not Resolved" Error Analysis</h1>
<p><strong>Date:</strong> December 12, 2025</p>
<p><strong>Error Message:</strong> <code>Failed to claim: execution reverted: "Not resolved"</code></p>

<h2>1. Error Analysis</h2>

<div class="error-box">
    <h3>Error Origin</h3>
    <p>The error occurs in <span class="file-path">ConditionalTokens.sol:160</span></p>
    <div class="code-block"><span class="keyword">function</span> <span class="function">redeemPositions</span>(...) <span class="keyword">external</span> {
    Condition <span class="keyword">storage</span> condition = conditions[conditionId];
    <span class="keyword">require</span>(condition.isResolved, <span class="string">"Not resolved"</span>);  <span class="comment">// &lt;-- Line 160</span>
    ...
}</div>
    <p>The <code>redeemPositions</code> function checks if the condition has been resolved on-chain before allowing token redemption.</p>
</div>

<h2>2. Root Cause</h2>

<div class="error-box">
    <h3>Function Mismatch</h3>
    <p>The API code calls a <strong>non-existent function</strong> on the ResolutionOracle contract:</p>
    <table>
        <tr>
            <th>File</th>
            <th>Code Being Called</th>
            <th>Problem</th>
        </tr>
        <tr>
            <td><span class="file-path">admin.ts:117</span></td>
            <td><code>resolutionOracle.resolveMarket(mkt.questionId, payoutIndex)</code></td>
            <td rowspan="2"><code>resolveMarket()</code> does NOT exist in the contract ABI</td>
        </tr>
        <tr>
            <td><span class="file-path">admin.ts:154</span></td>
            <td><code>resolutionOracle.resolveMarket(market.questionId, payoutIndex)</code></td>
        </tr>
    </table>
</div>

<h3>Available Functions in ResolutionOracle</h3>
<table>
    <tr>
        <th>Function</th>
        <th>Parameters</th>
        <th>Access</th>
        <th>Description</th>
    </tr>
    <tr>
        <td><code>proposeResolution</code></td>
        <td>questionId, outcomeSlotCount, payouts[]</td>
        <td>onlyResolver</td>
        <td>Proposes resolution, starts dispute period</td>
    </tr>
    <tr>
        <td><code>finalizeResolution</code></td>
        <td>questionId, outcomeSlotCount</td>
        <td>onlyResolver</td>
        <td>Finalizes after dispute period (1 day)</td>
    </tr>
    <tr>
        <td style="background: #e8f5e9;"><strong><code>adminFinalizeResolution</code></strong></td>
        <td>questionId, outcomeSlotCount, payouts[]</td>
        <td>onlyOwner</td>
        <td style="background: #e8f5e9;"><strong>Immediate resolution - bypasses dispute period</strong></td>
    </tr>
</table>

<h2>3. Execution Flow Comparison</h2>

<div class="flow-diagram">
    <h3>Current (Broken) Flow</h3>
    <span class="step">Admin clicks Resolve</span>
    <span class="arrow">&#8594;</span>
    <span class="step step-error">resolveMarket() FAILS</span>
    <span class="arrow">&#8594;</span>
    <span class="step">DB Updated (RESOLVED)</span>
    <span class="arrow">&#8594;</span>
    <span class="step">User clicks Claim</span>
    <span class="arrow">&#8594;</span>
    <span class="step step-error">redeemPositions() REVERTS</span>
    <br><br>
    <p><strong>Why it "worked before":</strong> The contract likely had a different implementation previously, or markets were resolved using a different mechanism.</p>
</div>

<div class="flow-diagram">
    <h3>Expected (Fixed) Flow</h3>
    <span class="step">Admin clicks Resolve</span>
    <span class="arrow">&#8594;</span>
    <span class="step">adminFinalizeResolution()</span>
    <span class="arrow">&#8594;</span>
    <span class="step">reportPayouts() called</span>
    <span class="arrow">&#8594;</span>
    <span class="step">condition.isResolved = true</span>
    <span class="arrow">&#8594;</span>
    <span class="step">User clicks Claim</span>
    <span class="arrow">&#8594;</span>
    <span class="step" style="background: #4caf50;">redeemPositions() SUCCESS</span>
</div>

<h2>4. Solution</h2>

<div class="solution-box">
    <h3>Fix Required in admin.ts</h3>
    <p>Replace <code>resolveMarket()</code> calls with <code>adminFinalizeResolution()</code></p>
</div>

<h3>Before (Broken)</h3>
<div class="code-block"><span class="comment">// Line 117 (grouped markets)</span>
<span class="keyword">const</span> tx = <span class="keyword">await</span> resolutionOracle.<span class="function">resolveMarket</span>(mkt.questionId, payoutIndex);

<span class="comment">// Line 154 (single markets)</span>
<span class="keyword">const</span> tx = <span class="keyword">await</span> resolutionOracle.<span class="function">resolveMarket</span>(market.questionId, payoutIndex);</div>

<h3>After (Fixed)</h3>
<div class="code-block"><span class="comment">// For Binary Markets (2 outcomes)</span>
<span class="keyword">const</span> outcomeSlotCount = 2;
<span class="keyword">const</span> payouts = payoutIndex === 0 ? [100, 0] : [0, 100]; <span class="comment">// 100 = winner</span>

<span class="comment">// Call adminFinalizeResolution instead</span>
<span class="keyword">const</span> tx = <span class="keyword">await</span> resolutionOracle.<span class="function">adminFinalizeResolution</span>(
    mkt.questionId,
    outcomeSlotCount,
    payouts
);</div>

<h2>5. Payout Array Format</h2>

<div class="warning-box">
    <h3>Important: Payouts Array</h3>
    <p>The <code>adminFinalizeResolution</code> function requires a payouts array, not just an index:</p>
    <table>
        <tr>
            <th>Winning Outcome</th>
            <th>payoutIndex</th>
            <th>payouts Array</th>
        </tr>
        <tr>
            <td>YES (first outcome)</td>
            <td>0</td>
            <td><code>[100, 0]</code></td>
        </tr>
        <tr>
            <td>NO (second outcome)</td>
            <td>1</td>
            <td><code>[0, 100]</code></td>
        </tr>
    </table>
    <p>The values represent percentage (100 = full payout to that outcome, 0 = no payout).</p>
</div>

<h2>6. Implementation Steps</h2>

<ol>
    <li><strong>Update admin.ts</strong> - Replace both <code>resolveMarket()</code> calls with <code>adminFinalizeResolution()</code></li>
    <li><strong>Calculate payouts array</strong> - Convert payoutIndex to proper array format</li>
    <li><strong>Add outcomeSlotCount</strong> - For binary markets, this is always 2</li>
    <li><strong>Test with a new market</strong> - Existing resolved markets in DB but not on-chain may need manual intervention</li>
</ol>

<h2>7. Existing Resolved Markets</h2>

<div class="warning-box">
    <h3>Markets Marked as RESOLVED in DB but Not On-Chain</h3>
    <p>Markets that were "resolved" using the broken code are only updated in the database - they are NOT resolved on-chain. To fix these:</p>
    <ol>
        <li>Identify all markets with <code>status: 'RESOLVED'</code> in the database</li>
        <li>For each market, call <code>adminFinalizeResolution</code> manually or via a migration script</li>
        <li>Verify on-chain resolution using <code>conditionalTokens.conditions(conditionId).isResolved</code></li>
    </ol>
</div>

<h2>8. Code Changes Summary</h2>

<table>
    <tr>
        <th>File</th>
        <th>Change</th>
        <th>Impact</th>
    </tr>
    <tr>
        <td><span class="file-path">api/src/routes/admin.ts</span></td>
        <td>Replace <code>resolveMarket</code> with <code>adminFinalizeResolution</code></td>
        <td>Enables on-chain resolution</td>
    </tr>
    <tr>
        <td>Lines affected</td>
        <td>117, 154</td>
        <td>Both grouped and single market resolution</td>
    </tr>
</table>

<h2>9. Restart Requirements</h2>

<p><strong>After implementing this fix:</strong></p>
<ul>
    <li><strong>API Server:</strong> YES - restart required</li>
    <li><strong>Web Server:</strong> No - frontend code unchanged</li>
</ul>

</body>
</html>
